<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 16px;
      }
      select, button {
        margin-top: 8px;
        width: 100%;
        padding: 6px;
      }
      #status {
        margin-top: 12px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h2>ðŸŽ² Randomize Seats</h2>
    <label for="classSelect">Select a class:</label>
    <select id="classSelect"></select>
    <button id="randomizeBtn">Randomize Selected Class</button>
    <button id="randomizeAllBtn" style="margin-top:8px;">Randomize All Classes</button>

    <div id="status"></div>

    <script>
      function showStatus(msg, color = "green") {
        const s = document.getElementById("status");
        s.textContent = msg;
        s.style.color = color;
      }

      function refreshDropdown() {
        google.script.run
          .withSuccessHandler(classSheets => {
            const select = document.getElementById("classSelect");
            const currentOptions = Array.from(select.options).map(o => o.value);
            const newOptions = new Set(classSheets);

            // Only rebuild if something changed
            if (
              classSheets.length !== currentOptions.length ||
              !classSheets.every(c => currentOptions.includes(c))
            ) {
              select.innerHTML = "";
              if (classSheets.length === 0) {
                showStatus("No class sheets found.", "red");
                document.getElementById("randomizeBtn").disabled = true;
                document.getElementById("randomizeAllBtn").disabled = true;
                return;
              }
              classSheets.forEach(name => {
                const opt = document.createElement("option");
                opt.value = name;
                opt.textContent = name.replace(/^Class - /, "");
                select.appendChild(opt);
              });
              showStatus("Class list updated.", "blue");
            }
          })
          .withFailureHandler(err => showStatus("Error loading classes: " + err.message, "red"))
          .getClassSheets();
      }

      // Initial load
      refreshDropdown();

      // Auto-refresh every 10 seconds
      setInterval(refreshDropdown, 10000);

      document.getElementById("randomizeBtn").addEventListener("click", () => {
        const selected = document.getElementById("classSelect").value;
        if (!selected) return showStatus("Please select a class.", "red");
        showStatus("Randomizing seats...", "blue");
        google.script.run
          .withSuccessHandler(() => showStatus(`Seats randomized for ${selected}. âœ…`))
          .withFailureHandler(err => showStatus("Error: " + err.message, "red"))
          .randomizeSeats(selected);
      });

      document.getElementById("randomizeAllBtn").addEventListener("click", () => {
        showStatus("Randomizing all classes...", "blue");
        google.script.run
          .withSuccessHandler(() => showStatus("All class seats randomized! âœ…"))
          .withFailureHandler(err => showStatus("Error: " + err.message, "red"))
          .randomizeAllClasses();
      });
    </script>
  </body>
</html>
