<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 12px;
      }
      select, button {
        width: 100%;
        margin-bottom: 10px;
        font-size: 14px;
        padding: 4px;
      }
      button {
        background: #1a73e8;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      button:disabled {
        background: #aaa;
        cursor: not-allowed;
      }
      .secondary {
        background: #5f6368;
      }
      #status {
        margin-top: 12px;
        font-size: 13px;
        color: #333;
      }
      .loading {
        color: #999;
        font-style: italic;
      }
      .success {
        color: #0a8043;
      }
      .error {
        color: #b31412;
      }
      hr {
        margin: 16px 0;
      }
    </style>
  </head>
  <body>
    <h3>Seat Wizard Dashboard</h3>

    <!-- CLASS AND TEMPLATE SELECTION -->
    <label>Class:</label>
    <select id="classSelect">
      <option value="">Loading classes...</option>
    </select>

    <label>Slide Template:</label>
    <select id="layoutSelect">
      <option value="">Loading templates...</option>
    </select>

    <!-- ACTION BUTTONS -->
    <button id="generateBtn" onclick="generateChart()">Generate Chart</button>
    <button class="secondary" id="generateAllBtn" onclick="generateAllCharts()">Generate Charts for All Classes</button>

    <hr>

    <!-- RANDOMIZER -->
    <button class="secondary" id="randomizeBtn" onclick="randomizeClass()">Randomize Selected Class</button>
    <button class="secondary" id="randomizeAllBtn" onclick="randomizeAll()">Randomize All Classes</button>

    <div id="status" class="loading">Loading data...</div>

    <script>
      // Load dropdowns for class sheets and templates
      function loadDropdowns() {
        google.script.run
          .withSuccessHandler(({ classes, templates }) => {
            const classSel = document.getElementById('classSelect');
            const layoutSel = document.getElementById('layoutSelect');
            const status = document.getElementById('status');

            classSel.innerHTML = classes.length
              ? classes.map(c => `<option value="${c}">${c.replace(/^Class - /, '')}</option>`).join('')
              : '<option value="">(No class sheets found)</option>';

            layoutSel.innerHTML = templates.length
              ? templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('')
              : '<option value="">(No slide templates found)</option>';

            status.textContent = 'Ready.';
            status.className = '';
          })
          .withFailureHandler(err => {
            const status = document.getElementById('status');
            status.textContent = `‚ö†Ô∏è Error loading data: ${err.message}`;
            status.className = 'error';
          })
          .getDropdownData();
      }

      // Generate chart for selected class
      function generateChart() {
        const classSelect = document.getElementById('classSelect');
        const layoutSelect = document.getElementById('layoutSelect');
        const status = document.getElementById('status');
        const button = document.getElementById('generateBtn');

        const className = classSelect.value;
        const templateId = layoutSelect.value;

        if (!className || !templateId) {
          status.textContent = '‚ö†Ô∏è Please select both a class and a slide template.';
          status.className = 'error';
          return;
        }

        button.disabled = true;
        status.innerHTML = '‚è≥ Generating chart...';
        status.className = 'loading';

        google.script.run
          .withSuccessHandler(url => {
            status.innerHTML = `
              ‚úÖ <span class="success">Seating chart generated!</span><br>
              <a href="${url}" target="_blank" style="color:#1a73e8;">View Seating Chart</a>
            `;
            status.className = '';
            button.disabled = false;
          })
          .withFailureHandler(err => {
            status.textContent = `‚ùå Error: ${err.message || err}`;
            status.className = 'error';
            button.disabled = false;
          })
          .generateSeatingChartFromSlideTemplate(className, templateId);
      }

      // Generate charts for all classes

      function generateAllCharts() {
       const layoutSelect = document.getElementById("layoutSelect");
        const templateId = layoutSelect.value;
        const status = document.getElementById("status");

        if (!templateId) {
          status.textContent = '‚ö†Ô∏è Please select a slide template first.';
          status.className = 'error';
          return;
        }

        status.innerHTML = "ü™Ñ Generating charts for all classes...";
        status.className = "loading";

        google.script.run
          .withSuccessHandler(result => {
            if (result.success) {
              status.innerHTML = `
                 ‚úÖ ${result.message}<br>
                <a href="${result.url}" target="_blank" style="color:#1a73e8;">Open generated Slides</a>
              `;
              if (result.errors && result.errors.length > 0) {
                status.innerHTML += `<br><br>‚ö†Ô∏è Errors:<br>${result.errors.join('<br>')}`;
              }
              status.className = "success";
            } else {
              status.textContent = "‚ùå Failed to generate charts.";
              status.className = "error";
            }
          })
          .withFailureHandler(err => {
            status.textContent = `‚ùå Error: ${err.message}`;
            status.className = "error";
          })
          .generateAllSeatingCharts(templateId);
      }




      // Randomize seats for selected class
      function randomizeClass() {
        const classSelect = document.getElementById('classSelect');
        const className = classSelect.value;
        const status = document.getElementById('status');

        if (!className) {
          status.textContent = '‚ö†Ô∏è Please select a class first.';
          status.className = 'error';
          return;
        }

        status.innerHTML = 'üé≤ Randomizing seats for selected class...';
        status.className = 'loading';

        google.script.run
          .withSuccessHandler(() => {
            status.innerHTML = `‚úÖ <span class="success">Seats randomized for ${className}.</span>`;
            status.className = '';
          })
          .withFailureHandler(err => {
            status.textContent = `‚ùå Error: ${err.message || err}`;
            status.className = 'error';
          })
          .randomizeSeatsForClass(className);
      }

      document.getElementById("classSelect").addEventListener("change", e => {
        const className = e.target.value;
        if (className) {
          google.script.run.switchToClassSheet(className);
        }
      });

      // Randomize seats for all classes
      function randomizeAll() {
        const status = document.getElementById('status');

        status.innerHTML = 'üé≤ Randomizing all classes...';
        status.className = 'loading';

        google.script.run
          .withSuccessHandler(() => {
            status.innerHTML = '‚úÖ <span class="success">All class seat numbers randomized!</span>';
            status.className = '';
          })
          .withFailureHandler(err => {
            status.textContent = `‚ùå Error: ${err.message || err}`;
            status.className = 'error';
          })
          .randomizeSeatsForAllClasses();
      }

      // Load data on open
      window.onload = loadDropdowns;
    </script>
  </body>
</html>
